import lodash from"lodash";function replaceLastStrs(orgStr,replaceStr,objType){var regexArray=/^.*(\[.*?\])$/;var regexObject=/^.*(\.\w*)$/;var replaceTemp="";var newStr="";if(objType===1){var regStrs=orgStr.match(regexArray);if(regStrs&&regStrs.length>=2){replaceTemp=regStrs[1];newStr=orgStr.substr(0,orgStr.lastIndexOf(replaceTemp))}else{newStr=orgStr}return`${newStr}${replaceStr}`}else{if(orgStr.indexOf(".")>=0){var regStrs=orgStr.match(regexObject);if(regStrs&&regStrs.length>=2){replaceTemp=regStrs[1];newStr=orgStr.substr(0,orgStr.lastIndexOf(replaceTemp))}else{newStr=orgStr}return`${newStr}.${replaceStr}`}else{return replaceStr}}}export const buildJsonMapping=(jOrg,jAim,jAimCurPath,jAimCur,mappings)=>{jAimCurPath=jAimCurPath||"";var mappingItem=null;var childMappings=[];var jAimCurType=typeof jAimCur;switch(jAimCurType.toLowerCase()){case"object":if(Array.isArray(jAimCur)){mappingItem=mappings.find((m=>m.AimJsonPath==jAimCurPath&&m.TranType==4));if(mappingItem){var jOrgCur=lodash.get(jOrg,mappingItem.OrgJsonPath);if(jOrgCur){var jOrgCurType=typeof jOrgCur;switch(jOrgCurType.toLowerCase()){case"object":if(Array.isArray(jOrgCur)){var regex=`^${jAimCurPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\[.*?\\]\\.\\w*`;childMappings=mappings.filter((m=>{var matchs=m.AimJsonPath.match(new RegExp(regex));return matchs&&matchs.length>0}));if(childMappings.length<=0){var jAim_CurChild=JSON.parse(JSON.stringify(jAimCur[0]));jAimCur.splice(0,jAimCur.length);for(var j=0;j<jOrgCur.length;j++){jAimCur.push(jAim_CurChild)}mappings.splice(mappings.indexOf(mappingItem),1)}else{var regexChild=`^${mappingItem.OrgJsonPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\[\\*\\]\\.\\w*`;var childMappingForPatten=childMappings.find((m=>{var matchs=m.OrgJsonPath.match(new RegExp(regexChild));return matchs&&matchs.length>0}));if(childMappingForPatten){for(var i=0;i<childMappings.length;i++){var childMapping=childMappings[i];mappings.splice(mappings.indexOf(childMapping),1);for(var j=0;j<jOrgCur.length;j++){mappings.push({AimJsonPath:childMapping.AimJsonPath.replace(`${mappingItem.AimJsonPath}[*]`,`${mappingItem.AimJsonPath}[${j}]`),OrgJsonPath:childMapping.OrgJsonPath.replace(`${mappingItem.OrgJsonPath}[*]`,`${mappingItem.OrgJsonPath}[${j}]`),TranType:childMapping.TranType})}}var jAim_CurChild=JSON.parse(JSON.stringify(jAimCur[0]));jAimCur.splice(0,jAimCur.length);for(var j=0;j<jOrgCur.length;j++){jAimCur.push(jAim_CurChild)}}}}else{var regex=`^${jAimCurPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\[.*?\\]\\.\\w*`;childMappings=mappings.filter((m=>{var matchs=m.AimJsonPath.match(new RegExp(regex));return matchs&&matchs.length>0}));if(childMappings.length<=0){mappings.splice(mappings.indexOf(mappingItem),1)}else{var regexChild=`^${mappingItem.OrgJsonPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\.\\*`;var childMappingList=childMappings.filter((m=>{var matchs=m.OrgJsonPath.match(new RegExp(regexChild));return matchs&&matchs.length>0}));childMappingList.forEach((item=>{mappings.splice(mappings.indexOf(item),1)}));var jAim_CurChild=JSON.parse(JSON.stringify(jAimCur[0]));jAimCur.splice(0,jAimCur.length);var jOrg_CurKeys=[];for(const key in jOrgCur){jOrg_CurKeys.push(key)}for(var i=0;i<jOrg_CurKeys.length;i++){childMappings.forEach((childMapping=>{mappings.push({AimJsonPath:childMapping.AimJsonPath.replace(`${mappingItem.AimJsonPath}[*]`,`${mappingItem.AimJsonPath}[${i}]`),OrgJsonPath:childMapping.OrgJsonPath.replace(`${mappingItem.OrgJsonPath}.*`,`${mappingItem.OrgJsonPath}.${jOrg_CurKeys[i]}`),TranType:childMapping.TranType})}));jAimCur.push(jAim_CurChild)}}}break;case"string":case"number":case"boolean":default:mappings.forEach((m=>{if(m.AimJsonPath.indexOf(`${jAimCurPath}.`)){mappings.splice(mappings.indexOf(m),1)}}))}}mappings.splice(mappings.indexOf(mappingItem),1)}}else{mappingItem=mappings.find((m=>m.AimJsonPath==jAimCurPath&&m.TranType==4));if(mappingItem){var jOrgCur=lodash.get(jOrg,mappingItem.OrgJsonPath);if(jOrgCur){var jOrgCurType=typeof jOrgCur;switch(jOrgCurType.toLowerCase()){case"object":if(Array.isArray(jOrgCur)){var regex=`^${jAimCurPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\.\\w*$`;childMappings=mappings.filter((m=>{var matchs=m.AimJsonPath.match(new RegExp(regex));return matchs&&matchs.length>0&&(m.TranType==3||m.TranType==4)}));if(childMappings.length<=0){mappings.splice(mappings.indexOf(mappingItem),1)}else{childMappings.forEach((m=>{mappings.splice(mappings.indexOf(m),1)}));for(var i=0;i<childMappings.length;i++){var childMapping=childMappings[i];var siblingMappings1=mappings.filter((m=>m.AimJsonPath.endsWith(`${childMapping.AimJsonPath}`)));siblingMappings1.forEach((m=>{mappings.splice(mappings.indexOf(m),1)}));var childMappings1=mappings.filter((m=>m.AimJsonPath.indexOf(`${childMapping.AimJsonPath}.`)>=0));childMappings1.forEach((m=>{mappings.splice(mappings.indexOf(m),1)}));for(var j=0;j<jOrgCur.length;j++){var orgJsonPath=childMapping.OrgJsonPath.replace("[*]",`[${j}]`);var newMapping={AimJsonPath:`${childMapping.AimJsonPath}${j}`,OrgJsonPath:`${orgJsonPath}`,TranType:childMapping.TranType};siblingMappings1.forEach((m=>{var aimChildJsonPath=m.AimJsonPath.replace(`${childMapping.AimJsonPath}`,`${newMapping.AimJsonPath}`);var regexSibling=`^${mappingItem.OrgJsonPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\[\\*\\]\\..*$`;var matchs=m.OrgJsonPath.match(new RegExp(regexSibling));var orgChildJsonPath=matchs&&matchs.length>0?m.OrgJsonPath.replace(`${mappingItem.OrgJsonPath}[*].`,`${mappingItem.OrgJsonPath}[${j}].`):m.OrgJsonPath;var newMappingChild={AimJsonPath:aimChildJsonPath,OrgJsonPath:orgChildJsonPath,TranType:m.TranType};mappings.push(newMappingChild)}));childMappings1.forEach((m=>{var aimChildJsonPath=m.AimJsonPath.replace(`${childMapping.AimJsonPath}.`,`${newMapping.AimJsonPath}.`);var regexChild=`^${mappingItem.OrgJsonPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\[\\*\\]\\..*$`;var matchs=m.OrgJsonPath.match(new RegExp(regexChild));var orgChildJsonPath=matchs&&matchs.length>0?m.OrgJsonPath.replace(`${mappingItem.OrgJsonPath}[*].`,`${mappingItem.OrgJsonPath}[${j}].`):m.OrgJsonPath;var newMappingChild={AimJsonPath:aimChildJsonPath,OrgJsonPath:orgChildJsonPath,TranType:m.TranType};mappings.push(newMappingChild)}));mappings.push(newMapping)}}var jAimChildKey=null;for(const key in jAimCur){jAimChildKey=key;break}if(jAimChildKey){var jAim_CurChild_Org=JSON.parse(JSON.stringify(jAimCur[jAimChildKey]));for(let prop in jAimCur){delete jAimCur[prop]}for(var j=0;j<jOrgCur.length;j++){var jAim_CurChild=JSON.parse(JSON.stringify(jAim_CurChild_Org));jAimCur[`${jAimChildKey}${j}`]=jAim_CurChild}}}}else{var regex=`^${jAimCurPath.replace("$","\\$").replace(".","\\.").replace("[","\\[").replace("]","\\]")}\\.\\w*$`;childMappings=mappings.filter((m=>{var matchs=m.AimJsonPath.match(new RegExp(regex));return matchs&&matchs.length>0}));if(childMappings.length<=0){var orgChildKeyList=[];for(const orgChildKey in jOrgCur){orgChildKeyList.push(orgChildKey)}for(const aimChildKey in jAimCur){if(orgChildKeyList.find((k=>k==aimChildKey))){var orgChildKey=aimChildKey;mappings.push({AimJsonPath:`${mappingItem.AimJsonPath}.${aimChildKey}`,OrgJsonPath:`${mappingItem.OrgJsonPath}.${orgChildKey}`,TranType:mappingItem.TranType})}}}}break;case"string":case"number":case"boolean":default:mappings.forEach((m=>{if(m.AimJsonPath.indexOf(`${jAimCurPath}.`)){mappings.splice(mappings.indexOf(m),1)}}))}}mappings.splice(mappings.indexOf(mappingItem),1)}}break;case"string":break;case"number":break;case"boolean":break;default:}switch(jAimCurType.toLowerCase()){case"object":for(const key in jAimCur){var jAim_CurChild=jAimCur[key];var jAim_CurChildType=typeof jAim_CurChild;var jAim_CurChildPath="";switch(jAim_CurChildType.toLowerCase()){case"object":if(Array.isArray(jAimCur)){jAim_CurChildPath=jAimCurPath?`${jAimCurPath}[${key}]`:`[${key}]`}else{jAim_CurChildPath=jAimCurPath?`${jAimCurPath}.${key}`:`${key}`}break;default:jAim_CurChildPath=jAimCurPath?`${jAimCurPath}.${key}`:`${key}`;break}if(jAim_CurChildPath){buildJsonMapping(jOrg,jAim,jAim_CurChildPath,jAim_CurChild,mappings)}}break;default:break}};export const transJson=(jOrg,jAim,jAimCurPath,jAimCur,mappings)=>{var regexArray=/^.*(\[.*?\])$/;var regexObject=/^.*(\.\w*)$/;var newJAimCurPath=jAimCurPath;var jAim_Cur_MappingList=mappings.filter((d=>d.AimJsonPath==jAimCurPath));jAim_Cur_MappingList.forEach((mappingItem=>{var jAimCurPaths=lodash.toPath(mappingItem.AimJsonPath);var jAimCurKey=JSON.parse(JSON.stringify(jAimCurPaths)).splice(jAimCurPaths.length-1,1)[0];var jAimCurParentPaths=lodash.initial(jAimCurPaths);var jAimCurParent=lodash.get(jAim,jAimCurParentPaths,jAim);var jOrgCur=lodash.get(jOrg,mappingItem.OrgJsonPath);var jOrgCurPaths=lodash.toPath(mappingItem.OrgJsonPath);var jOrgCurKey=JSON.parse(JSON.stringify(jOrgCurPaths)).splice(jOrgCurPaths.length-1,1)[0];var jOrgCurParentPaths=lodash.initial(jOrgCurPaths);var jOrgCurParent=lodash.get(jOrg,jOrgCurParentPaths,jOrg);switch(mappingItem.TranType){case 1:var jAimCurParentType=typeof jAimCurParent;switch(jAimCurParentType.toLowerCase()){case"object":if(Array.isArray(jAimCurParent)){jAimCurParent.splice(jAimCurParent.indexOf(jAimCur),1);newJAimCurPath=replaceLastStrs(`${jAimCurPath}`,`[${jOrgCurKey}]`,1)}else{newJAimCurPath=replaceLastStrs(`${jAimCurPath}`,`${jOrgCurKey}`,2);delete jAimCurParent[jAimCurKey]}jAimCurParent[jOrgCurKey]=jAimCur;var replaceMappting=mappingItem.AimJsonPath;mappings.forEach((item=>{item.AimJsonPath=item.AimJsonPath.replace(`${replaceMappting}`,newJAimCurPath)}));break;default:break}break;case 2:jAimCurParent[jAimCurKey]=jOrgCurKey;break;case 3:var jAimCurParentType=typeof jAimCurParent;switch(jAimCurParentType.toLowerCase()){case"object":if(Array.isArray(jAimCurParent)){jAimCurParent.splice(jAimCurParent.indexOf(jAimCur),1);newJAimCurPath=replaceLastStrs(`${jAimCurPath}`,`[${jOrgCur}]`,1)}else{newJAimCurPath=replaceLastStrs(`${jAimCurPath}`,`${jOrgCur}`,2);delete jAimCurParent[jAimCurKey]}jAimCurParent[jOrgCur]=jAimCur;var replaceMappting=mappingItem.AimJsonPath;mappings.forEach((item=>{item.AimJsonPath=item.AimJsonPath.replace(`${replaceMappting}`,newJAimCurPath)}));break;default:break}break;case 4:jAimCurParent[jAimCurKey]=jOrgCur;break;default:break}}));var jAimCurType=typeof jAimCur;switch(jAimCurType.toLowerCase()){case"object":for(const key in jAimCur){var jAim_CurChild=jAimCur[key];var jAim_CurChildType=typeof jAim_CurChild;var jAim_CurChildPath="";switch(jAim_CurChildType.toLowerCase()){case"object":if(Array.isArray(jAimCur)){jAim_CurChildPath=newJAimCurPath?`${newJAimCurPath}[${key}]`:`[${key}]`}else{jAim_CurChildPath=newJAimCurPath?`${newJAimCurPath}.${key}`:`${key}`}break;default:jAim_CurChildPath=newJAimCurPath?`${newJAimCurPath}.${key}`:`${key}`;break}transJson(jOrg,jAim,jAim_CurChildPath,jAim_CurChild,mappings)}break;default:break}};